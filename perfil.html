<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <title>Perfil do Cliente - eKoverde</title>
    <style>
        :root {
            --cor-primaria: #28a745;
            --cor-primaria-hover: #218838;
            --cor-secundaria: #dc3545;
            --cor-texto: #333;
            --cor-texto-claro: #666;
            --cor-fundo: #f4f7f6;
            --cor-branco: #ffffff;
            --sombra-card: 0 4px 8px rgba(0,0,0,0.1);
        }
        body {
            font-family: 'Poppins', Arial, sans-serif;
            background-color: var(--cor-fundo);
            margin: 0;
            padding: 20px;
            color: var(--cor-texto);
        }
        .perfil-container {
            max-width: 900px;
            margin: 20px auto;
            background-color: transparent;
        }
        h1 {
            text-align: center;
            color: var(--cor-texto);
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        h2 {
            color: var(--cor-primaria);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--cor-primaria);
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .info-section {
            background-color: var(--cor-branco);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--sombra-card);
            margin-bottom: 25px;
        }
        .info-section p {
            font-size: 16px;
            color: var(--cor-texto-claro);
            line-height: 1.6;
        }
        #foto-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        .foto-perfil-wrapper {
            position: relative;
            cursor: pointer;
        }
        #foto-perfil {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--cor-primaria);
            transition: filter 0.3s ease;
        }
        .foto-perfil-wrapper:hover #foto-perfil {
            filter: brightness(0.8);
        }
        .foto-perfil-wrapper::after {
            content: '\F4F2';
            font-family: 'bootstrap-icons';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 32px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .foto-perfil-wrapper:hover::after {
            opacity: 1;
        }
        #input-foto {
            display: none;
        }
        #dados-pessoais .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            vertical-align: middle;
        }
        th {
            background-color: var(--cor-primaria);
            color: white;
            font-weight: bold;
        }
        tbody tr:nth-child(even) { background-color: #f9f9f9; }
        .btn {
            padding: 12px 24px;
            background-color: var(--cor-primaria);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-right: 10px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-weight: 500;
        }
        .btn:hover { background-color: var(--cor-primaria-hover); transform: scale(1.05); }
        .btn-edit { background-color: #6c757d; }
        .btn-edit:hover { background-color: #5a6268; }
        .btn-logout { background-color: var(--cor-secundaria); }
        .btn-logout:hover { background-color: #c82333; }
        .btn-track {
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            font-size: 0.9em;
            border-radius: 5px;
        }
        .btn-track:hover { background-color: #0056b3; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 30px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 12px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        .site-footer { background-color: #333; color: #ccc; padding: 30px 0; margin-top: 40px; font-size: 14px; }
        .footer-logo { max-width: 140px; }
    </style>
</head>
<body>
    <div class="perfil-container">
        <h1><i class="bi bi-person-circle"></i> Perfil do Cliente</h1>

        <div class="info-section" id="foto-section">
            <label for="input-foto" class="foto-perfil-wrapper">
                <img id="foto-perfil" src="https://via.placeholder.com/150" alt="Foto do Perfil">
            </label>
            <input type="file" id="input-foto" accept="image/*">
            <h2 id="nome-display" style="margin-top: 15px; border: none;"></h2>
        </div>

        <div class="info-section" id="dados-pessoais">
            <div class="header">
                <h2><i class="bi bi-person-vcard"></i> Dados Pessoais</h2>
                <button id="btn-abrir-modal" class="btn btn-edit"><i class="bi bi-pencil-square"></i> Editar</button>
            </div>
            <p id="email"></p>
            <p id="telefone"></p>
            <p id="endereco"></p>
            <p id="data-nascimento"></p>
        </div>

        <div class="info-section" id="historico-section">
            <h2><i class="bi bi-receipt-cutoff"></i> Histórico de Compras</h2>
            <table>
                <thead>
                    <tr>
                        <th>Produto</th>
                        <th>Qtd.</th>
                        <th>Valor</th>
                        <th>Frete</th>
                        <th>Total Pago</th>
                        <th>Data</th>
                        <th>Rastreamento</th>
                    </tr>
                </thead>
                <tbody id="rastreamento-list"></tbody>
            </table>
        </div>
        
        <div class="info-section" style="text-align: center;">
            <a href="index.html" class="btn"><i class="bi bi-house"></i> Voltar à Página Inicial</a>
            <button class="btn btn-logout" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Sair</button>
        </div>
    </div>
    
    <div id="modal-edicao" class="modal">
        <div class="modal-content">
            <span id="close-modal" class="close-btn">&times;</span>
            <h2>Editar Dados Pessoais</h2>
            <form id="form-edicao">
                <div class="form-group"><label for="edit-nome">Nome Completo</label><input type="text" id="edit-nome" required></div>
                <div class="form-group"><label for="edit-telefone">Telefone</label><input type="tel" id="edit-telefone"></div>
                <div class="form-group"><label for="edit-endereco">Endereço</label><input type="text" id="edit-endereco"></div>
                <div class="form-group"><label for="edit-data-nascimento">Data de Nascimento</label><input type="date" id="edit-data-nascimento"></div>
                <button type="submit" class="btn">Salvar Alterações</button>
            </form>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const clienteLogado = JSON.parse(localStorage.getItem("clienteLogado"));
        if (!clienteLogado || !clienteLogado.email) {
            window.location.href = "entrar.html";
            return;
        }

        let clientes = JSON.parse(localStorage.getItem("clientes")) || [];
        let clienteAtual = clientes.find(c => c.email === clienteLogado.email);

        if (!clienteAtual) {
            alert("Cliente não encontrado!");
            logout();
            return;
        }

        const fotoPerfilEl = document.getElementById("foto-perfil");
        const nomeDisplayEl = document.getElementById("nome-display");
        const emailEl = document.getElementById("email");
        const telefoneEl = document.getElementById("telefone");
        const enderecoEl = document.getElementById("endereco");
        const dataNascimentoEl = document.getElementById("data-nascimento");
        const rastreamentoListEl = document.getElementById("rastreamento-list");

        function formatCurrency(value) {
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function generateTrackingHTML(item) {
            if (!item.codigoRastreio) {
                return `<span>Aguardando Envio</span>`;
            }
            if (item.status === 'Entregue') {
                return `<span style="color: green;"><i class="bi bi-check-circle-fill"></i> ${item.status}</span><br><small>${item.codigoRastreio}</small>`;
            }
            return `<button class="btn btn-track" onclick="trackOrder('${item.codigoRastreio}')"><i class="bi bi-truck"></i> Rastrear</button><br><small>${item.codigoRastreio}</small>`;
        }
        
        window.trackOrder = function(trackingCode) {
            localStorage.setItem('trackingToView', trackingCode);
            window.location.href = 'rastreamento.html';
        }

        function carregarDadosNaTela() {
            fotoPerfilEl.src = clienteAtual.foto || "https://via.placeholder.com/150";
            nomeDisplayEl.textContent = clienteAtual.nome || 'Nome não informado';
            emailEl.innerHTML = `<strong>E-mail:</strong> ${clienteAtual.email || 'Não informado'}`;
            telefoneEl.innerHTML = `<strong>Telefone:</strong> ${clienteAtual.telefone || 'Não informado'}`;
            enderecoEl.innerHTML = `<strong>Endereço:</strong> ${clienteAtual.endereco || 'Não informado'}`;
            dataNascimentoEl.innerHTML = `<strong>Data de Nascimento:</strong> ${clienteAtual.data_nascimento ? new Date(clienteAtual.data_nascimento).toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : 'Não informada'}`;

            const historicoCompras = JSON.parse(localStorage.getItem("historicoCompras")) || [];
            const clienteHistorico = historicoCompras.filter(item => item.cliente === clienteAtual.email);
            rastreamentoListEl.innerHTML = "";
            
            if (clienteHistorico.length > 0) {
                clienteHistorico.forEach(item => {
                    const subtotal = item.price * item.quantity;
                    const frete = subtotal * 0.05; // Assumindo 5% de frete
                    const totalPago = subtotal + frete;
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${item.name || 'Produto'}</td>
                        <td>${item.quantity}</td>
                        <td>${formatCurrency(subtotal)}</td>
                        <td>${formatCurrency(frete)}</td>
                        <td><strong>${formatCurrency(totalPago)}</strong></td>
                        <td>${item.dataCompra || 'N/A'}</td>
                        <td>${generateTrackingHTML(item)}</td>
                    `;
                    rastreamentoListEl.appendChild(row);
                });
            } else {
                rastreamentoListEl.innerHTML = "<tr><td colspan='7' style='text-align:center;'>Nenhum histórico de compras encontrado.</td></tr>";
            }
        }
        
        window.logout = function() {
            localStorage.removeItem("clienteLogado");
            window.location.href = "index.html";
        }
        
        const modal = document.getElementById("modal-edicao");
        document.getElementById("btn-abrir-modal").onclick = () => {
            document.getElementById("edit-nome").value = clienteAtual.nome || "";
            document.getElementById("edit-telefone").value = clienteAtual.telefone || "";
            document.getElementById("edit-endereco").value = clienteAtual.endereco || "";
            document.getElementById("edit-data-nascimento").value = clienteAtual.data_nascimento || "";
            modal.style.display = "block";
        }
        document.getElementById("close-modal").onclick = () => modal.style.display = "none";
        window.onclick = (event) => { if (event.target == modal) { modal.style.display = "none"; } }

        document.getElementById("form-edicao").onsubmit = (e) => {
            e.preventDefault();
            clienteAtual.nome = document.getElementById("edit-nome").value;
            clienteAtual.telefone = document.getElementById("edit-telefone").value;
            clienteAtual.endereco = document.getElementById("edit-endereco").value;
            clienteAtual.data_nascimento = document.getElementById("edit-data-nascimento").value;
            
            const indiceCliente = clientes.findIndex(c => c.email === clienteAtual.email);
            if (indiceCliente !== -1) {
                clientes[indiceCliente] = clienteAtual;
                localStorage.setItem("clientes", JSON.stringify(clientes));
            }
            carregarDadosNaTela();
            modal.style.display = "none";
            alert("Dados atualizados com sucesso!");
        };

        document.getElementById("input-foto").addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const fotoBase64 = e.target.result;
                fotoPerfilEl.src = fotoBase64;
                clienteAtual.foto = fotoBase64;
                const indiceCliente = clientes.findIndex(c => c.email === clienteAtual.email);
                if (indiceCliente !== -1) {
                    clientes[indiceCliente] = clienteAtual;
                    localStorage.setItem("clientes", JSON.stringify(clientes));
                }
            };
            reader.readAsDataURL(file);
        });
        
        carregarDadosNaTela();
    });
    </script>
</body>
</html>