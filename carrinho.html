<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Carrinho - eKoviva</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --cor-primaria: #28a745;
            --cor-primaria-hover: #218838;
            --cor-fundo: #f4f7f6;
            --cor-branco: #ffffff;
            --sombra-suave: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--cor-fundo);
            color: #333;
        }
        header {
            background-color: var(--cor-primaria);
            color: white;
            text-align: center;
            padding: 20px;
        }
        header h1 {
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 30px auto;
            background-color: var(--cor-branco);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--sombra-suave);
        }
        .cart-container h2 {
            color: var(--cor-primaria);
            border-bottom: 2px solid var(--cor-primaria);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .cart-items table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .cart-items th, .cart-items td {
            border-bottom: 1px solid #eee;
            padding: 15px;
            text-align: left;
            vertical-align: middle;
        }
        .cart-items th {
            background-color: var(--cor-secundaria);
            font-weight: 600;
        }
        .cart-items td img { width: 60px; height: 60px; border-radius: 8px; margin-right: 15px; object-fit: cover; }
        .quantity-controls { display: flex; align-items: center; }
        .quantity-controls button { background: #e0e0e0; color: #333; border: 1px solid #ccc; padding: 5px 10px; cursor: pointer; border-radius: 5px; }
        .quantity-controls span { padding: 0 15px; font-weight: bold; }
        .action-btn { background: #ff6b6b; color: white; border: none; border-radius: 5px; cursor: pointer; padding: 8px 12px; }
        
        .summary-container { display: flex; justify-content: flex-end; }
        .summary-box { background-color: var(--cor-secundaria); padding: 20px; border-radius: 8px; min-width: 300px; }
        .summary-box p { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .summary-box .total { font-size: 1.2em; font-weight: bold; color: var(--cor-primaria); border-top: 1px solid #ddd; padding-top: 10px; }
        
        .cart-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; }
        .cart-actions button { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; display: flex; align-items: center; gap: 8px; transition: background-color 0.3s; }
        .checkout-btn { background: var(--cor-primaria); color: white; }
        .back-btn { background: #777; color: white; }
        .clear-cart-btn { background: #f44336; color: white; }
        
        .empty-cart-message { text-align: center; padding: 40px 20px; background-color: var(--cor-secundaria); border-radius: 8px; }
        .empty-cart-message p { font-size: 1.2em; }
        .empty-cart-message a { color: var(--cor-primaria); font-weight: bold; }
    </style>
</head>
<body>
    <header>
        <h1><i class="bi bi-cart4"></i> Meu Carrinho</h1>
    </header>

    <div class="container">
        <div class="cart-container">
            <h2>Itens no Carrinho</h2>
            <div id="cart-display-area"></div>
            
            <div id="summary-section" class="summary-container" style="display: none;">
                <div class="summary-box">
                    <p><span>Subtotal:</span> <span id="subtotal-price">R$ 0,00</span></p>
                    <p><span>Frete:</span> <span id="freight-price">R$ 0,00</span></p>
                    <p class="total"><span>Total a Pagar:</span> <span id="total-price">R$ 0,00</span></p>
                </div>
            </div>

            <div id="cart-actions-section" class="cart-actions" style="display: none;">
                <button class="back-btn" onclick="goBack('index.html')"><i class="bi bi-arrow-left"></i> Continuar Comprando</button>
                <button class="clear-cart-btn" onclick="clearCart()"><i class="bi bi-trash"></i> Limpar Carrinho</button>
                <button class="checkout-btn" onclick="proceedToPayment()">Ir para o Pagamento <i class="bi bi-arrow-right"></i></button>
            </div>
        </div>
    </div>

    <script>
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        const clienteLogado = JSON.parse(localStorage.getItem("clienteLogado"));

        const cartDisplayArea = document.getElementById("cart-display-area");
        const subtotalPriceEl = document.getElementById("subtotal-price");
        const freightPriceEl = document.getElementById("freight-price");
        const totalPriceEl = document.getElementById("total-price");
        const summarySection = document.getElementById("summary-section");
        const cartActionsSection = document.getElementById("cart-actions-section");

        function renderCart() {
            // Se não estiver logado, redireciona
            if (!clienteLogado) {
                alert("Você precisa estar logado para ver seu carrinho.");
                window.location.href = "entrar.html";
                return;
            }

            // Filtra o carrinho para mostrar apenas itens do cliente logado
            let userCart = cart.filter(item => item.cliente === clienteLogado.email);
            
            cartDisplayArea.innerHTML = '';
            let subtotal = 0;

            if (userCart.length === 0) {
                cartDisplayArea.innerHTML = `<div class="empty-cart-message"><p>Seu carrinho está vazio!</p><a href="index.html">Comece a comprar</a></div>`;
                summarySection.style.display = 'none';
                cartActionsSection.style.display = 'none';
                return;
            }

            summarySection.style.display = 'flex';
            cartActionsSection.style.display = 'flex';

            const table = document.createElement('table');
            table.className = 'cart-items';
            table.innerHTML = `<thead><tr><th>Produto</th><th>Preço</th><th>Quantidade</th><th>Subtotal</th><th>Ação</th></tr></thead><tbody id="cart-items-body"></tbody>`;
            cartDisplayArea.appendChild(table);
            const cartItemsBody = document.getElementById("cart-items-body");

            userCart.forEach(item => {
                const itemSubtotal = item.price * item.quantity;
                subtotal += itemSubtotal;
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${item.image ? `<img src="${item.image}" alt="${item.name}">` : ''} ${item.name}</td>
                    <td>${formatCurrency(item.price)}</td>
                    <td><div class="quantity-controls"><button onclick="decrementQuantity('${item.name}')">-</button><span>${item.quantity}</span><button onclick="incrementQuantity('${item.name}')">+</button></div></td>
                    <td>${formatCurrency(itemSubtotal)}</td>
                    <td><button class="action-btn" onclick="removeFromCart('${item.name}')"><i class="bi bi-trash"></i></button></td>`;
                cartItemsBody.appendChild(row);
            });

            const freight = subtotal * 0.05; // 5% de frete
            const total = subtotal + freight;

            subtotalPriceEl.textContent = formatCurrency(subtotal);
            freightPriceEl.textContent = formatCurrency(freight);
            totalPriceEl.textContent = formatCurrency(total);
        }

        function updateLocalStorage() {
            localStorage.setItem('cart', JSON.stringify(cart));
            renderCart();
        }

        function incrementQuantity(productName) {
            const item = cart.find(p => p.name === productName && p.cliente === clienteLogado.email);
            if (item) item.quantity++;
            updateLocalStorage();
        }

        function decrementQuantity(productName) {
            const item = cart.find(p => p.name === productName && p.cliente === clienteLogado.email);
            if (item && item.quantity > 1) {
                item.quantity--;
            } else {
                removeFromCart(productName);
            }
            updateLocalStorage();
        }

        function removeFromCart(productName) {
            cart = cart.filter(item => !(item.name === productName && item.cliente === clienteLogado.email));
            updateLocalStorage();
        }

        function clearCart() {
            if (confirm("Tem certeza que deseja limpar todos os itens do carrinho?")) {
                cart = cart.filter(item => item.cliente !== clienteLogado.email);
                updateLocalStorage();
            }
        }

        function proceedToPayment() {
            window.location.href = "pagamento.html";
        }
        
        function goBack(page) { window.location.href = page; }
        function formatCurrency(amount) { return amount.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }

        renderCart();
    </script>
</body>
</html>